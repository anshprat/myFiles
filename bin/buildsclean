#!/bin/bash
#set -xe
##
# function reserved_builds gid returnvar
# The first arg is the sheet id to use. Can be found from the gid param of the
# url of the google sheet
# The second arg is the function return variable name
# http://www.linuxjournal.com/content/return-values-bash-functions
##
function reserved_builds {
    gid=$1
    sheetid="1V75IDtU8GWH2sX5G0dKQDH6K2RX5RZaoJQX0MoIEW4g"
    local  __resultvar=$2
    url="https://docs.google.com/spreadsheets/d/${sheetid}/export?gid=${gid}&format=csv"
    local result=`curl -s $url|cut -f 1 -d ','|grep ^[0-9]|paste -sd'|'`
    eval $__resultvar="'$result'"
}

function check_build_status {
    build_number=$1
    if [[ $build_number == *"pkg"* ]]
    then
        # Its a pkg-test build
        job_name="puppet_rjil_pkg_test"
        build_number=`echo $1|cut -b 10-`
    elif [[ $build_number == *"test"* ]]
    then
        #Its an AT env
        job_name=pipeline-at-deploy
        build_number=`echo $1|cut -b 5-`
    else
        # Its a gate
        job_name='puppet-rjil-gate'
    fi
    echo "Checking build $i"
    build_url="http://jiocloud.rustedhalo.com:8080/job/${job_name}/${build_number}/api/json"
    build_running_status=`curl -s ${build_url}|jshon -e result`
    delete_build $1 $build_running_status
}

function delete_build {
    build_number=$1
    result=$2
    if [ $result != "null" ]
    then
        echo "Build $build_number status: $result"
        echo -n "Deleting build $build_number in  "
        for t in `seq 5 -1 0`
        do
            echo -ne "\b${t}"
            sleep 1
        done
        echo
        if [[ $build_number == *"pkg"* ]]
        then
            # Its a pkg-test build
            resource=" testjenkins-puppet_rjil_${build_number}"
        elif [[ $build_number == *"test"* ]]
        then
            #Its an AT env
            resource=" ${build_number}"
        else
            # Its a gate
            resource=" testjenkins-puppet-rjil-gate-${build_number}"
        fi
        python -m jiocloud.apply_resources delete $resource
    else
        echo "Build $i is still building, not deleting"
    fi

}

echo "Checking gate builds"
reserved_builds 0 reserved
for i in `nova list|grep testjenkins-puppet-rjil-gate |awk '{print $4}'|cut -f 5 -d '-'|sort|uniq|grep -vE "$reserved"`
do
check_build_status $i
done

echo "Checking AT environments"
reserved_builds 770431315 reserved
for i in `nova list|grep _test |grep -v jenkins|awk '{print $4}'|cut -f 2 -d '_'|sort -u|grep [0-9]|grep -vE "$reserved"`
do
check_build_status $i
done

echo "Checking pkg-test builds"
reserved_builds 768834840 reserved
for i in `nova list|grep pkg_test |awk '{print $4}'|cut -f 4- -d '_'|sort -u|grep -vE "$reserved"`
do
check_build_status $i
done
